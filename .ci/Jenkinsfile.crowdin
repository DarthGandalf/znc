#!groovy

timestamps {
  node {
    timeout(time: 30, unit: 'MINUTES') {
      def crowdin_cli = tool 'crowdin-cli';
      crowdin_cli = "java -jar $crowdin_cli/crowdin-cli.jar --config .ci/crowdin.yml"
      stage('Checkout') {
        step([$class: 'WsCleanup'])
        checkout([$class: 'GitSCM', branches: [[name: '*/crowdin']], doGenerateSubmoduleConfigurations: false, extensions: [[$class: 'CloneOption', shallow: true], [$class: 'SubmoduleOption', recursiveSubmodules: true]], userRemoteConfigs: [[credentialsId: '6ef10f80-20dc-4661-af45-52a6e1e15749', name: 'upstream', url: 'github.com:DarthGandalf/znc.git']]])
      }
      stage('Prepare strings') {
        dir("build") {
          sh "cmake .."
          sh 'make translation'
        }
        sh 'rm -rf build/'
        sh 'git status'
      }
      stage('Crowdin') {
        withCredentials([string(credentialsId: '11c7e2b4-f990-4670-98a4-c89d2a5a2f43', variable: 'CROWDIN_API_KEY')]) {
          withEnv(['CROWDIN_BASE_PATH='+pwd()]) {
            sh "$crowdin_cli upload sources --branch master"
            sh "$crowdin_cli upload translations --branch master"
            sh "$crowdin_cli download --branch master"
          }
        }
      }
      stage('Push') {
        sh 'git config user.name "ZNC-Jenkins"'
        sh 'git config user.email jenkins@znc.in'
        sh 'git status'
        sh 'git add .'
        sh 'git commit -m "Update translations from Crowdin"'
        sh 'git remote add my github.com:znc-jenkins/znc.git'
        // TODO simplify when https://issues.jenkins-ci.org/browse/JENKINS-28335 is fixed
        withCredentials([sshUserPrivateKey(credentialsId: '6ef10f80-20dc-4661-af45-52a6e1e15749', keyFileVariable: 'GITHUB_KEY')]) {
          sh 'echo -- ssh -i $GITHUB_KEY -l git -o StrictHostKeyChecking=no \\"$@\\" > run_ssh.sh'
          sh 'chmod +x run_ssh.sh'
          sh 'cat run_ssh.sh'
          withEnv(['GIT_SSH=run_ssh.sh']) {
            sh 'git push my HEAD:l10n_master -f'
          }
        }
      }
    }
  }
}

// vim: set ts=2 sw=2 et:
